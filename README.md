# Jenkins cmake builds

## Структура 
Репозитарий состоит из следующих директорий.

- **cmake-config**  --  настройки для сборки cmake'ом под различные архитектуры.
- **cpp-cross-platform** -- минимальный C++ проект для отладки и настройки конфигов сборки под различные платформы. Не используется непосредственно для развертывания автосборок.
- **docker** -- содержит docker-файлы для создания образов, содержащих toolchain под соответствующую платформу для компиляции на C++ (поддерживается x86_64 и arm32v7).
- **jenkins-builds** -- backup проекта сборки на jenkins для быстрого развертывания.
- **scripts** -- bash-скрипты, используемые в jenkins-сборке.
- **docs** -- подробное описание как настроить систему сборки с нуля.

## Архитектура

Система сборки работает на некотором сервере (назовем его Server-VM-1) под Ubuntu 22.04, (настраивалось на виртуальной машине из Yandex Cloud). На сервере нужно установить Jenkins, Docker, Java environment. 

Компиляция кода происходит внутри запущенного Docker-контейнера. Для x86_64 и arm32v7 используются два разных Docker-image'a. 

Запуск и выполнение build-проекта основаны на вызове четырех shell скриптов 
 - сборка для архитектуры x86_64
 - запуск тестов с сохранением вывода в файл (для x86_64)
 - сборка для архитектуры arm32v7 (с использованием соответствуюшего toolchain, определяемом в .cmake файле)
 - выгрузка двух библиотек libtiff.so (x86_64 и arm32v7) по scp на второй сервер (назовем его Deploy-VM-2), использовалась еще одна машина из Yandex Cloud, также под Ubuntu 22.04. Результаты с тестами передаются с помощью плагина Publish over SSH для демонстрации передачи различными способами.

## Как настроить

Подробная инструкция по настройке находится в **docs/instruction.txt**. Некоторые шаги можно пропускать, если что-то уже установлено.

Shell-скрипты нужно положить в папку /usr/local/bin на Server-VM-1.

На Deploy-VM-2 сервере нужно сделать три поддиректории для выгрузки артефактов (см. инструкцию).

Копирование между серверами происходит по протоколу ssh, поэтому нужно для соответствующих пользователей добавить открытые ключи.

Сам сборочный проект можно настроить по шагам инструкции, либо восстановить с помощью Jenkins CLIб, указав имя пользователя и токен в переменных окружения.
```
java -jar jenkins-cli.jar -s http://158.160.105.42:8080/ create-job ubuntu-build-cmake-2 < ubuntu-build-cmake_backup.xml
```
Здесь нужно указать IP сервера, где будет разворачиваться проект (Server-VM-1).

Также важно в глобальных настройках для Publish over SSH плагина указать адрес сервера и закрытый ключ и протестировать соединение.

У проекта сборки три параметра, которые можно изменить либо в настройках проекта, либо перед параметризованным запуском.
